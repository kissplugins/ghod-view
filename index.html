<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GHOD View - GitHub Daily Activity Stream</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif; background: #f6f8fa; color: #24292f; }
    .header { background: white; border-bottom: 1px solid #d0d7de; padding: 16px 32px; display: flex; justify-content: space-between; align-items: center; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .logo { width: 40px; height: 40px; background: #4169e1; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px; }
    .header-title h1 { font-size: 18px; font-weight: 600; margin-bottom: 2px; }
    .header-title p { font-size: 13px; color: #57606a; }
    .header-right { display: flex; align-items: center; gap: 20px; font-size: 13px; color: #57606a; }
    .container { max-width: 1400px; margin: 0 auto; padding: 24px 32px; display: flex; gap: 24px; }
    .main-content { flex: 2; }
    .sidebar { flex: 1; max-width: 380px; }
    .day-section { background: white; border: 1px solid #d0d7de; border-radius: 6px; margin-bottom: 16px; overflow: hidden; }
    .day-header { font-size: 16px; font-weight: 600; padding: 16px 20px; border-bottom: 1px solid #d0d7de; background: #f6f8fa; }
    .activity-item { padding: 16px 20px; border-bottom: 1px solid #d0d7de; display: flex; gap: 12px; }
    .activity-item:last-child { border-bottom: none; }
    .activity-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 14px; color: white; font-weight: bold; }
    .activity-icon.push { background: #0969da; }
    .activity-icon.create { background: #1a7f37; }
    .activity-icon.delete { background: #cf222e; }
    .activity-icon.issues { background: #d29922; }
    .activity-icon.member { background: #8250df; }
    .activity-content { flex: 1; }
    .activity-type { font-size: 12px; color: #57606a; font-weight: 500; margin-bottom: 4px; }
    .activity-repo { font-size: 14px; }
    .activity-repo a { color: #0969da; text-decoration: none; font-weight: 500; }
    .activity-repo a:hover { text-decoration: underline; }
    .activity-desc { font-size: 13px; color: #57606a; margin-top: 4px; }
    .activity-time { font-size: 12px; color: #57606a; margin-top: 4px; }
    .activity-branch { font-size: 12px; color: #57606a; margin-top: 4px; }
    .activity-branch a { color: #0969da; text-decoration: none; }
    .activity-branch a:hover { text-decoration: underline; }
    .card { background: white; border: 1px solid #d0d7de; border-radius: 6px; margin-bottom: 16px; overflow: hidden; }
    .card-header { padding: 16px 20px; border-bottom: 1px solid #d0d7de; display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; }
    .card-body { padding: 20px; }
    .notes-textarea { width: 100%; min-height: 120px; padding: 12px; border: 1px solid #d0d7de; border-radius: 6px; font-size: 13px; font-family: inherit; resize: vertical; }
    .notes-textarea:focus { outline: none; border-color: #0969da; }
    .notes-hint { font-size: 12px; color: #57606a; margin-top: 8px; }
    .issue-item { padding: 12px 0; border-bottom: 1px solid #d0d7de; }
    .issue-item:first-child { padding-top: 0; }
    .issue-item:last-child { border-bottom: none; padding-bottom: 0; }
    .issue-title { font-size: 14px; margin-bottom: 6px; }
    .issue-title a { color: #24292f; text-decoration: none; font-weight: 500; }
    .issue-title a:hover { color: #0969da; }
    .issue-meta { font-size: 12px; color: #57606a; }
    .issue-number { background: #f6f8fa; padding: 2px 6px; border-radius: 4px; font-weight: 500; }
    .repos-bar { background: white; border-bottom: 1px solid #d0d7de; padding: 12px 32px; font-size: 13px; }
    .repos-bar a { color: #0969da; text-decoration: none; margin: 0 8px; }
    .repos-bar a:hover { text-decoration: underline; }
    .filter-bar { background: white; border-bottom: 1px solid #d0d7de; padding: 12px 32px; display: flex; align-items: center; gap: 10px; font-size: 13px; }
    .filter-label { font-size: 12px; color: #57606a; }
    .filter-button { padding: 6px 10px; background: #f6f8fa; border: 1px solid #d0d7de; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; color: #24292f; }
    .filter-button.active { background: #0969da; border-color: #0969da; color: white; }
    .filter-button:disabled { opacity: 0.5; cursor: default; }
    .debug-chip { padding: 4px 8px; border: 1px dashed #d0d7de; border-radius: 6px; background: #f6f8fa; font-size: 12px; color: #57606a; }
    .debug-card { background: #fff8dc; border: 1px dashed #d29922; border-radius: 6px; margin: 12px 32px 0 32px; padding: 12px 16px; font-size: 12px; color: #24292f; }
    .debug-pre { background: #fff; border: 1px solid #d0d7de; border-radius: 6px; padding: 8px; overflow: auto; font-size: 12px; line-height: 1.5; }
    .config-bar { background: white; border-bottom: 1px solid #d0d7de; padding: 10px 32px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; font-size: 13px; }
    .config-toggle { padding: 6px 10px; background: #f6f8fa; border: 1px solid #d0d7de; border-radius: 6px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; }
    .config-toggle.active { background: #1a7f37; border-color: #1a7f37; color: white; }
    .footer { background: white; border-top: 1px solid #d0d7de; padding: 20px 32px; text-align: center; font-size: 12px; color: #57606a; margin-top: 40px; }
    .footer a { color: #0969da; text-decoration: none; }
    .footer a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    function GitHubActivityFeed() {
      const [token, setToken] = React.useState(localStorage.getItem('gh_token') || '');
      const [activity, setActivity] = React.useState([]);
      const [assignedIssues, setAssignedIssues] = React.useState([]);
      const [notes, setNotes] = React.useState(localStorage.getItem('daily_notes') || '');
      const [user, setUser] = React.useState(null);
      const [loading, setLoading] = React.useState(false);
      const [tokenInput, setTokenInput] = React.useState('');
      const [copySuccess, setCopySuccess] = React.useState(false);
      const [gistSuccess, setGistSuccess] = React.useState(false);
      const [savingGist, setSavingGist] = React.useState(false);
      const [dayFilter, setDayFilter] = React.useState('today');
      const [showDebug, setShowDebug] = React.useState(true);
      const [showConfig, setShowConfig] = React.useState(false);
      const [enableDebugUI, setEnableDebugUI] = React.useState(true);
      const [debugInfo, setDebugInfo] = React.useState({ fetchError: null, keys: [] });
      
      React.useEffect(() => {
        if (token) {
          fetchActivity();
        }
      }, []);
      
      async function copyToClipboard() {
        try {
          await navigator.clipboard.writeText(notes);
          setCopySuccess(true);
          setTimeout(() => setCopySuccess(false), 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
          alert('Failed to copy to clipboard');
        }
      }
      
      async function saveToGist() {
        if (!notes || !token) return;
        setSavingGist(true);
        setGistSuccess(false);
        
        const today = new Date().toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        
        const gistData = {
          description: `GHOD View Notes - ${today}`,
          public: false,
          files: {
            [`ghod-notes-${new Date().toISOString().split('T')[0]}.md`]: {
              content: `# GHOD View Notes - ${today}\n\n${notes}`
            }
          }
        };
        
        try {
          const response = await fetch('https://api.github.com/gists', {
            method: 'POST',
            headers: {
              'Authorization': `token ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(gistData)
          });
          
          if (response.ok) {
            const gist = await response.json();
            setGistSuccess(true);
            setTimeout(() => setGistSuccess(false), 3000);
            // Optionally open the gist in a new tab
            window.open(gist.html_url, '_blank');
          } else {
            throw new Error('Failed to create gist');
          }
        } catch (err) {
          console.error('Failed to save to gist:', err);
          alert('Failed to save to GitHub Gist. Make sure your token has "gist" scope.');
        } finally {
          setSavingGist(false);
        }
      }
      
      async function fetchActivity() {
        if (!token) return;
        setLoading(true);
        const headers = { 'Authorization': `token ${token}` };
        setDebugInfo((prev) => ({ ...prev, fetchError: null }));
        
        try {
          // Fetch authenticated user
          const userResponse = await fetch('https://api.github.com/user', { headers });
          if (!userResponse.ok) throw new Error(`User fetch failed: ${userResponse.status}`);
          const userData = await userResponse.json();
          setUser(userData);
        
          
          // Fetch user events
          const response = await fetch(`https://api.github.com/users/${userData.login}/events?per_page=100`, { headers });
          if (!response.ok) throw new Error(`Events fetch failed: ${response.status}`);
          const events = await response.json();
          
          // Group by local day (timezone-aware)
          const grouped = events.reduce((acc, event) => {
            const day = getLocalDayKey(event.created_at);
            if (!acc[day]) acc[day] = [];
            acc[day].push(event);
            return acc;
          }, {});
          const keys = Object.keys(grouped).sort();
          console.log('GHOD day keys (local tz)', keys);
          setDebugInfo((prev) => ({ ...prev, keys }));
          setActivity(grouped);
          
          // Fetch assigned issues
          const issuesResponse = await fetch('https://api.github.com/issues?filter=assigned&state=open&sort=updated&per_page=5', { headers });
          if (!issuesResponse.ok) throw new Error(`Issues fetch failed: ${issuesResponse.status}`);
          const issues = await issuesResponse.json();
          setAssignedIssues(issues);
        } catch (error) {
          console.error('Error fetching data:', error);
          setDebugInfo((prev) => ({ ...prev, fetchError: error?.message || 'Unknown error' }));
          alert('Failed to load GitHub data. Please check your token.');
        } finally {
          setLoading(false);
        }
      }
      
      function handleLogin() {
        if (tokenInput) {
          setToken(tokenInput);
          localStorage.setItem('gh_token', tokenInput);
          fetchActivity();
        }
      }
      
      function handleLogout() {
        setToken('');
        setUser(null);
        setActivity([]);
        setAssignedIssues([]);
        localStorage.removeItem('gh_token');
      }
      
      const getEventIcon = (type) => {
        const icons = {
          'PushEvent': { label: '‚ûú', class: 'push' },
          'CreateEvent': { label: '+', class: 'create' },
          'DeleteEvent': { label: '√ó', class: 'delete' },
          'IssuesEvent': { label: '‚óã', class: 'issues' },
          'IssueCommentEvent': { label: '‚óã', class: 'issues' },
          'PullRequestEvent': { label: '‚ûú', class: 'push' },
          'MemberEvent': { label: '‚òÖ', class: 'member' }
        };
        return icons[type] || { label: '‚Ä¢', class: 'push' };
      };

      const getEventDescription = (event) => {
        const time = new Date(event.created_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        
        if (event.type === 'PushEvent') {
          return event.payload.commits?.[0]?.message || 'Updated code';
        } else if (event.type === 'CreateEvent') {
          return `Created new ${event.payload.ref_type} "${event.payload.ref || ''}"`;
        } else if (event.type === 'DeleteEvent') {
          return `Removed deprecated ${event.payload.ref_type} "${event.payload.ref}"`;
        } else if (event.type === 'IssuesEvent') {
          return `Opened issue: ${event.payload.issue?.title || ''}`;
        } else if (event.type === 'IssueCommentEvent') {
          return `Commented on issue`;
        }
        return '';
      };

      const getBranchData = (event) => {
        const ref = event?.payload?.ref;
        const repo = event?.repo?.name;
        if (!ref || !repo) return null;
        const branch = ref.replace(/^refs\/heads\//, '');
        if (!branch) return null;
        return {
          branch,
          url: `https://github.com/${repo}/tree/${branch}`
        };
      };

      const getLocalDayKey = (value) => new Date(value).toLocaleDateString('en-CA');

      const todayDate = new Date();
      const todayLabel = todayDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
      const todayKey = getLocalDayKey(todayDate);
      const previousDate = new Date(todayDate);
      previousDate.setDate(previousDate.getDate() - 1);
      const previousDayLabel = previousDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
      const previousDayKey = getLocalDayKey(previousDate);
      const selectedDayLabel = dayFilter === 'today' ? todayLabel : previousDayLabel;
      const availableDayKeys = Object.keys(activity || {}).sort().reverse();
      const filteredActivityEntries = Object.entries(activity).filter(([day]) => {
        if (dayFilter === 'today') return day === todayKey;
        if (dayFilter === 'previous') return day === previousDayKey;
        return true;
      });
      
      // Get unique repos scoped to current filter (fallback to all if none)
      const activeEvents = (filteredActivityEntries.length ? filteredActivityEntries.flatMap(([, evts]) => evts) : Object.values(activity).flat());
      const uniqueRepos = [...new Set(activeEvents.map(e => e.repo.name))].sort();
      
      if (!token) {
        return (
          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', minHeight: '100vh', background: '#f6f8fa' }}>
            <div style={{ background: 'white', padding: '40px', borderRadius: '12px', border: '1px solid #d0d7de', maxWidth: '400px', width: '100%' }}>
              <div style={{ textAlign: 'center', marginBottom: '24px' }}>
                <div className="logo" style={{ margin: '0 auto 12px', width: '60px', height: '60px', fontSize: '28px' }}>GT</div>
                <h1 style={{ fontSize: '24px', marginBottom: '8px' }}>GHOD View</h1>
                <p style={{ color: '#57606a', fontSize: '14px' }}>GitHub Daily Activity Stream</p>
              </div>
              <div>
                <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', marginBottom: '8px' }}>GitHub Personal Access Token</label>
                <input 
                  type="password" 
                  value={tokenInput}
                  onChange={(e) => setTokenInput(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                  placeholder="ghp_xxxxxxxxxxxx"
                  style={{ width: '100%', padding: '8px 12px', border: '1px solid #d0d7de', borderRadius: '6px', fontSize: '14px', marginBottom: '12px' }}
                />
                <button 
                  onClick={handleLogin}
                  style={{ width: '100%', padding: '10px', background: '#0969da', color: 'white', border: 'none', borderRadius: '6px', fontSize: '14px', fontWeight: '600', cursor: 'pointer' }}
                >
                  Sign In
                </button>
                <p style={{ fontSize: '12px', color: '#57606a', marginTop: '12px', textAlign: 'center' }}>
                  Need a token? <a href="https://github.com/settings/tokens" target="_blank" rel="noopener noreferrer" style={{ color: '#0969da' }}>Generate one here</a><br/>
                  <span style={{ fontSize: '11px' }}>Scopes needed: <code>repo</code>, <code>read:user</code>, <code>gist</code></span>
                </p>
              </div>
            </div>
          </div>
        );
      }
      
      return (
        <div>
          <div className="header">
            <div className="header-left">
              <div className="logo">GT</div>
              <div className="header-title">
                <h1>GHOD View</h1>
                <p>GitHub Daily Activity Stream</p>
              </div>
            </div>
            <div className="header-right">
              <span>üë§ {user?.login || 'Loading...'}</span>
              <span>üìÖ {todayLabel}</span>
              <button 
                onClick={handleLogout}
                style={{ padding: '6px 12px', background: '#f6f8fa', border: '1px solid #d0d7de', borderRadius: '6px', fontSize: '12px', cursor: 'pointer' }}
              >
                Sign Out
              </button>
            </div>
          </div>
          
          <div className="config-bar">
            <button className="config-toggle" onClick={() => setShowConfig(!showConfig)}>
              {showConfig ? 'Hide Settings' : 'Show Settings'}
            </button>
            {showConfig && (
              <>
                <button 
                  className={`config-toggle ${showDebug ? 'active' : ''}`}
                  onClick={() => setShowDebug(!showDebug)}
                >
                  {showDebug ? 'Hide' : 'Show'} Debug Panel
                </button>
                <button 
                  className={`config-toggle ${enableDebugUI ? 'active' : ''}`}
                  onClick={() => setEnableDebugUI(!enableDebugUI)}
                >
                  {enableDebugUI ? 'Disable' : 'Enable'} Debug UI
                </button>
              </>
            )}
          </div>

          {uniqueRepos.length > 0 && (
            <div className="repos-bar">
              <strong>Active Repos:</strong>
              {uniqueRepos.map((repo, i) => (
                <span key={repo}>
                  <a href={`https://github.com/${repo}`} target="_blank" rel="noopener noreferrer">{repo}</a>
                  {i < uniqueRepos.length - 1 && ' |'}
                </span>
              ))}
            </div>
          )}

          <div className="filter-bar">
            <span className="filter-label">View</span>
            <button 
              className={`filter-button ${dayFilter === 'today' ? 'active' : ''}`}
              onClick={() => setDayFilter('today')}
            >
              Today
            </button>
            <button 
              className={`filter-button ${dayFilter === 'previous' ? 'active' : ''}`}
              onClick={() => setDayFilter('previous')}
            >
              Previous Day
            </button>
            <span className="filter-label">Showing {selectedDayLabel}</span>
            <span className="debug-chip" onClick={() => setShowDebug(!showDebug)} style={{ cursor: 'pointer' }}>
              Debug {showDebug ? '‚ñæ' : '‚ñ∏'}
            </span>
          </div>

          {showDebug && enableDebugUI && (
            <div className="debug-card">
              <div><strong>Debug:</strong> dayFilter={dayFilter}, todayKey={todayKey}, previousDayKey={previousDayKey}</div>
              <div style={{ marginTop: '6px' }}>Available days (newest first):</div>
              <div className="debug-pre">{availableDayKeys.join('\n') || 'none'}</div>
              {debugInfo.fetchError && (
                <div style={{ marginTop: '6px', color: '#cf222e' }}>Fetch error: {debugInfo.fetchError}</div>
              )}
              {debugInfo.keys?.length > 0 && (
                <div style={{ marginTop: '6px' }}>Console keys: {debugInfo.keys.join(', ')}</div>
              )}
            </div>
          )}

          <div className="container">
            <div className="main-content">
              {filteredActivityEntries.length === 0 ? (
                <div className="card">
                  <div className="card-body">
                    <div style={{ color: '#57606a', fontSize: '13px' }}>
                      {loading ? 'Loading activity...' : `No activity for ${selectedDayLabel}.`}
                    </div>
                  </div>
                </div>
              ) : (
                filteredActivityEntries.map(([day, events]) => {
                  const date = new Date(day + 'T00:00:00');
                  const formatted = date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                  });
                  
                  return (
                    <div key={day} className="day-section">
                      <div className="day-header">{formatted}</div>
                      {events.map(e => {
                        const icon = getEventIcon(e.type);
                        const desc = getEventDescription(e);
                        const time = new Date(e.created_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        const branchInfo = getBranchData(e);
                        const isBranchEvent = branchInfo && (
                          e.type === 'PushEvent' ||
                          (e.type === 'CreateEvent' && e.payload?.ref_type === 'branch') ||
                          (e.type === 'DeleteEvent' && e.payload?.ref_type === 'branch')
                        );
                        
                        return (
                          <div key={e.id} className="activity-item">
                            <div className={`activity-icon ${icon.class}`}>{icon.label}</div>
                            <div className="activity-content">
                              <div className="activity-type">{e.type.replace('Event', '')}</div>
                              <div className="activity-repo">
                                <a href={`https://github.com/${e.repo.name}`} target="_blank" rel="noopener noreferrer">
                                  {e.repo.name}
                                </a>
                              </div>
                              {isBranchEvent && branchInfo && (
                                <div className="activity-branch">
                                  Branch: <a href={branchInfo.url} target="_blank" rel="noopener noreferrer">{branchInfo.branch}</a>
                                </div>
                              )}
                              {desc && <div className="activity-desc">{desc}</div>}
                              <div className="activity-time">{time}</div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  );
                })
              )}
            </div>
            
            <div className="sidebar">
              <div className="card">
                <div className="card-header">
                  üìù My Notes for Today
                </div>
                <div className="card-body">
                  <textarea 
                    className="notes-textarea"
                    value={notes}
                    onChange={(e) => {
                      setNotes(e.target.value);
                      localStorage.setItem('daily_notes', e.target.value);
                    }}
                    placeholder="Add your notes for today..."
                  />
                  <button 
                    className={`copy-btn ${copySuccess ? 'success' : ''}`}
                    onClick={copyToClipboard}
                    disabled={!notes}
                  >
                    {copySuccess ? '‚úì Copied!' : 'üìã Copy to Clipboard'}
                  </button>
                  <button 
                    className={`gist-btn ${gistSuccess ? 'success' : ''}`}
                    onClick={saveToGist}
                    disabled={!notes || savingGist}
                  >
                    {savingGist ? 'üíæ Saving...' : gistSuccess ? '‚úì Saved to Gist!' : 'üíæ Save to GitHub Gist'}
                  </button>
                  <div className="notes-hint">These notes will only appear on this computer</div>
                </div>
              </div>

              <div className="card">
                <div className="card-header">
                  ‚è∞ Assigned Issues
                </div>
                <div className="card-body">
                  {assignedIssues.map(issue => {
                    const repoName = issue.repository_url.split('/').slice(-2).join('/');
                    const repoUrl = `https://github.com/${repoName}`;
                    
                    return (
                      <div key={issue.id} className="issue-item">
                        <div className="issue-title">
                          <a href={issue.html_url} target="_blank" rel="noopener noreferrer">
                            {issue.title}
                          </a>
                        </div>
                        <div className="issue-meta">
                          <a href={repoUrl} target="_blank" rel="noopener noreferrer">{repoName}</a> ‚Ä¢ <span className="issue-number">#{issue.number}</span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>
          <div className="footer">
            GHOD View ¬© Copyright 2026 Hypercart | <a href="mailto:info@hypercart.io">info@hypercart.io</a> | <a href="https://github.com/kissplugins/ghod-view/blob/main/LICENSE" target="_blank" rel="noopener noreferrer">FSL 5 License</a>
          </div>
        </div>
      );
    }
    
    ReactDOM.render(<GitHubActivityFeed />, document.getElementById('root'));
  </script>
</body>
</html>